<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>商品頁面</title>
  <link rel="icon" type="image/png" href="/image/favicon.png">
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- 導覽列 -->
    <div id="navbar"></div>

    <!-- 商品展示 -->
    <div class="product-grid" id="productGrid"></div>

    <!-- 浮水印 -->
    <img src="/image/浮水印.jpg" class="watermark-img">

    <!-- 頁尾 -->
    <div id="footer"></div>

    <script type="module">
    import { logout , loadUserStatus } from "/static/js/auth.js";
    import { controlNavbarLinks } from "/static/js/navbar.js";
        // 1. 載入 navbar 與 footer

    const navRes = await fetch("/static/components/navbar.html");
    document.getElementById("navbar").innerHTML = await navRes.text();

    await loadUserStatus();
    controlNavbarLinks();
    
    const footerRes = await fetch("/static/components/footer.html");
    document.getElementById("footer").innerHTML = await footerRes.text();



    // 3. 抓商品清單
    const prodRes = await fetch("/api/products");
    const data = await prodRes.json();

    const productGrid = document.getElementById("productGrid");
    data.products.forEach(p => {
        const form = document.createElement("form");
        form.className = "product-card";
        form.onsubmit = function (e) {
            addToCart(e, form);
        };

        form.innerHTML = `
            <img src="${p.img}" class="product-image" alt="${p.name}">
            <h2 class="product-name">${p.name}</h2>
            <p class="product-description">${p.description}</p>
            <p class="product-price">價格：${p.price} 元</p>

            <input type="hidden" name="name" value="${p.name}">
            <input type="hidden" name="price" value="${p.price}">
            <input type="hidden" name="img" value="${p.img}">

            <div class="quantity-control">
                <button type="button" onclick="changeQuantity(this, -1)">－</button>
                <input type="text" name="quantity" value="0" readonly>
                <button type="button" onclick="changeQuantity(this, 1)">＋</button>
            </div>

            <button type="submit" class="add_to_cart">加入購物車</button>
        `;
        productGrid.appendChild(form);
    });

    function changeQuantity(btn, delta) {
        const input = btn.parentNode.querySelector("input[name='quantity']");
        let qty = parseInt(input.value);
        if (qty + delta < 0) return;
        if (qty + delta > 10) {
            alert("最多只能購買 10 件, 需大量訂購請私訊 Instagram");
            return;
        }
        input.value = qty + delta;
    }

    function addToCart(event, form) {
        event.preventDefault();
        const fd = new FormData(form);
        const payload = {
        name: fd.get("name"),
        price: parseInt(fd.get("price"), 10),
        img: fd.get("img"),
        quantity: parseInt(fd.get("quantity"), 10),
        };
        fetch("/add_to_cart", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
        })
        .then(res => res.json())
        .then(result => {
            if (result.error === "not_logged_in") {
                window.location.href = "/login.html";
            } else {
                alert("✅ 已加入購物車！");
            }
        })
        .catch(error => {
            console.error("❌ 錯誤：", error);
            alert("❌ 發生錯誤！");
        });
    }
    window.logout = logout;
    window.changeQuantity = changeQuantity;
    window.addToCart = addToCart;
    </script>
</body>
</html>
