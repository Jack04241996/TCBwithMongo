<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>thecrunchybear</title>
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- å°è¦½åˆ— -->
    <div id="navbar"></div>
    <div class = cart-page>
        <h2>ğŸ›’ è³¼ç‰©è»Š</h2>
        <table>
            <tr>
                <th>å•†å“</th>
                <th>åœ–ç‰‡</th>
                <th>å–®åƒ¹</th>
                <th>æ•¸é‡</th>
                <th>å°è¨ˆ</th>
                <th>æ“ä½œ</th>
            </tr>
            {% for item in cart_items %}
            <tr>
                <td>{{ item.name }}</td>
                <td><img src="{{ item.img }}" width="80"></td>
                <td class="price">{{ item.price }}</td>
                <td>
                    <div class="quantity-control">
                        <button type="button" onclick="changeQuantity(this, -1)">ï¼</button>
                        <input type="text" name="quantity" value="{{ item.quantity }}" readonly>
                        <input type="hidden" name="name" value="{{ item.name }}">
                        <button type="button" onclick="changeQuantity(this, 1)">ï¼‹</button>
                    </div>
                </td>
                <td class="subtotal">{{ item.price * item.quantity }}</td>
                <td>
                    <form method="post" action="/remove_from_cart">
                        <input type="hidden" name="name" value="{{ item.name }}">
                        <button type="submit">ç§»é™¤</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>
        <h3>ç¸½é‡‘é¡ï¼š<span id="total-amount">{{ total }}</span> å…ƒ</h3>
    </div>


    <script type="module">
    import { logout, loadUserStatus, isTokenExpired } from "/static/js/auth.js";
    import { controlNavbarLinks } from "/static/js/navbar.js";

    const navRes = await fetch("/static/components/navbar.html");
    document.getElementById("navbar").innerHTML = await navRes.text();

    await loadUserStatus();
    controlNavbarLinks();
    
    const footerRes = await fetch("/static/components/footer.html");
    document.getElementById("footer").innerHTML = await footerRes.text();
    
    function changeQuantity(btn, delta) {
            const input = btn.parentNode.querySelector("input[name='quantity']");
            let qty = parseInt(input.value);
            const MAX_QTY = 10;
            const MIN_QTY = 0;

            // æª¢æŸ¥æ˜¯å¦è¶…éä¸Šé™
            if (qty >= MAX_QTY && delta > 0) {
                alert("æœ€å¤šåªèƒ½è³¼è²· " + MAX_QTY + " ä»¶,éœ€å¤§é‡è¨‚è³¼è«‹è¯ç§è¨ŠInstergram");
                return;
            }

            // æª¢æŸ¥æ˜¯å¦ä½æ–¼ä¸‹é™
            if (qty <= MIN_QTY && delta < 0) {
                return;
            }

            // æ›´æ–°æ•¸å€¼
            qty = qty + delta;
            input.value = qty;
            const row = btn.closest("tr");
            const price = parseInt(row.querySelector(".price").innerText) || 0;
            row.querySelector(".subtotal").innerText = price * qty;

            // æ›´æ–°ç¸½é‡‘é¡
            updateTotal();
        }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll(".subtotal").forEach(cell => {
            total += parseInt(cell.innerText) || 0;
        });
        document.getElementById("total-amount").innerText = total;
    }

    window.onload = updateTotal;
    window.logout = logout;
    </script>

</body>
</html>
